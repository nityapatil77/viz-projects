<aside>
üêù

Here is an overview of all the procedures that were implemented to create the database.

</aside>

# 1. add_airplane()

```sql
drop procedure if exists add_airplane;
delimiter //

create procedure add_airplane (
    in ip_airlineID varchar(50), 
    in ip_tail_num varchar(50),
    in ip_seat_capacity integer, 
    in ip_speed integer, 
    in ip_locationID varchar(50),
    in ip_plane_type varchar(100), 
    in ip_maintenanced boolean, 
    in ip_model varchar(50),
    in ip_neo boolean
)
sp_main: begin
    -- Must be sponsored by an existing airline
    if (select count(*) from airline where airlineID = ip_airlineID) < 1 then 
        leave sp_main;
    end if;

    -- Tail number must be unique per airline
    if (select count(*) from airplane where airlineID = ip_airlineID and tail_num = ip_tail_num) > 0 then 
        leave sp_main;
    end if;

    -- Seat capacity and speed must be positive
    if ip_seat_capacity <= 0 or ip_speed <= 0 then 
        leave sp_main;
    end if;

    -- Conditional checks based on airplane type
    if ip_plane_type = 'Airbus' then 
        if ip_neo is null then
            leave sp_main;
        end if;
    elseif ip_plane_type = 'Boeing' then 
        if ip_maintenanced is null or ip_model is null then 
            leave sp_main;
        end if; 
    end if;

    -- Location must be new and unique
    if (select count(*) from location where locationID = ip_locationID) > 0 then 
        leave sp_main;
    end if;

    -- Insert into location
    insert into location (locationID) values (ip_locationID);

    -- Insert into airplane
    insert into airplane (
        airlineID, tail_num, seat_capacity, speed, locationID,
        plane_type, maintenanced, model, neo
    ) values (
        ip_airlineID, ip_tail_num, ip_seat_capacity, ip_speed, ip_locationID,
        ip_plane_type, ip_maintenanced, ip_model, ip_neo
    );

end // 
delimiter ;
```

# 2. add_airport()

```sql
drop procedure if exists add_airport;
delimiter //
create procedure add_airport (in ip_airportID char(3), in ip_airport_name varchar(200),
    in ip_city varchar(100), in ip_state varchar(100), in ip_country char(3), in ip_locationID varchar(50))
sp_main: begin
	-- unique airportID 
    if (select count(*) from airport where airportID = ip_airportID) > 0 then 
			leave sp_main; 
		end if; 
    
    -- unique locationID
    if (select count(*) from location where locationID = ip_locationID) > 0 then
			leave sp_main;
		end if;

    -- must have a city, state, country 
    if ip_city is null or ip_state is null or ip_country is null then
			leave sp_main;
		end if;
    
  insert into location values (ip_locationID);
    
	insert into airport values (ip_airportID, ip_airport_name, ip_city, ip_state, ip_country, ip_locationID);

end //
delimiter ;
```

# 3. add_person()

```sql
drop procedure if exists add_person;
delimiter //
create procedure add_person (in ip_personID varchar(50), in ip_first_name varchar(100),
    in ip_last_name varchar(100), in ip_locationID varchar(50), in ip_taxID varchar(50),
    in ip_experience integer, in ip_miles integer, in ip_funds integer)
sp_main: begin

	-- Ensure that the location is valid
    if not exists (select * from location where locationID=ip_locationID) then
			leave sp_main;
		end if;
    -- Ensure that the personID is unique
    if exists (select * from person where personID=ip_personID) then
			leave sp_main;
		end if;
    -- Ensure that the person is a pilot or passenger
    IF (ip_taxID IS NOT NULL AND ip_experience IS NOT NULL AND ip_miles IS NULL AND ip_funds IS NULL) THEN
        -- person table
        INSERT INTO person (personID, first_name, last_name, locationID)
        VALUES (ip_personID, ip_first_name, ip_last_name, ip_locationID);
        -- pilot table
        INSERT INTO pilot (personID, taxID, experience)
        VALUES (ip_personID, ip_taxID, ip_experience);
    ELSEIF (ip_miles IS NOT NULL AND ip_funds IS NOT NULL AND ip_taxID IS NULL AND ip_experience IS NULL) THEN
        -- person table
        INSERT INTO person (personID, first_name, last_name, locationID)
        VALUES (ip_personID, ip_first_name, ip_last_name, ip_locationID);
        -- passenger table
        INSERT INTO passenger (personID, miles, funds)
        VALUES (ip_personID, ip_miles, ip_funds);
    ELSE
        -- invalid role parameters, exit without insertion
        LEAVE sp_main;
    END IF;

end //
delimiter ;
```

# 4. grant_or_revoke_pilot_license()

```sql
DROP PROCEDURE IF EXISTS grant_or_revoke_pilot_license;
DELIMITER //

CREATE PROCEDURE grant_or_revoke_pilot_license (
    IN in_person_id VARCHAR(50),
    IN in_license_type VARCHAR(100)
)
sp_main: BEGIN
    DECLARE v_pilot_exists INT DEFAULT 0;
    DECLARE v_license_exists INT DEFAULT 0;

    -- Check if the person is a pilot
    SELECT COUNT(*) INTO v_pilot_exists
    FROM pilot
    WHERE personID = in_person_id;

    IF v_pilot_exists > 0 THEN

        -- Check if the license already exists
        SELECT COUNT(*) INTO v_license_exists
        FROM pilot_licenses
        WHERE personID = in_person_id AND license = in_license_type;

        IF v_license_exists > 0 THEN
            DELETE FROM pilot_licenses
            WHERE personID = in_person_id AND license = in_license_type;
        ELSE
            INSERT INTO pilot_licenses (personID, license)
            VALUES (in_person_id, in_license_type);
        END IF;

    END IF;
END //

DELIMITER ;

```

# 5. offer_flight()

```sql
drop procedure if exists offer_flight;
delimiter //
create procedure offer_flight (in ip_flightID varchar(50), in ip_routeID varchar(50),
    in ip_support_airline varchar(50), in ip_support_tail varchar(50), in ip_progress integer,
    in ip_next_time time, in ip_cost integer)
sp_main: begin
    declare progress_int int;
    declare airplane_status_val varchar(20); 
    -- Route must exist and determine number of stops
    select count(*) into progress_int from route_path where routeID = ip_routeID;
    
    -- Progress must be less than number of stops
    if ip_progress >= progress_int then
        leave sp_main;
    end if;

    -- FlightID must be unique
    if (select count(*) from flight where flightID = ip_flightID) > 0 then
        leave sp_main;
    end if;

    -- Time and cost must not be null
    if ip_next_time is null or ip_cost is null then
        leave sp_main;
    end if;

    -- Airplane checks (if provided)
    if ip_support_airline is not null or ip_support_tail is not null then
			if ip_progress is null or ip_next_time is null then 
            leave sp_main;
        end if;

        -- Ensure airplane is not already used
        if (select count(*) from flight where support_airline = ip_support_airline and support_tail = ip_support_tail) > 0 then
            leave sp_main;
        end if;
    end if;

    -- Insert the flight
    insert into flight values (
        ip_flightID, ip_routeID, ip_support_airline, ip_support_tail,
        ip_progress, 'on_ground', ip_next_time, ip_cost
    );

end //
delimiter ;
```

# 6. flight_landing()

```sql
drop procedure if exists flight_landing;
delimiter //
create procedure flight_landing (in ip_flightID varchar(50))
sp_main: begin
		declare v_current_leg integer default 0;
    declare v_current_status varchar(100) default null;
    declare v_curr_next_time time default null;
    declare v_new_airplane_status varchar(100) default null;
    declare v_new_next_time time default null;
    declare v_supp_airline varchar(50) default null;
    declare v_supp_tail varchar(50) default null;
    declare v_num_miles integer default 0;
    declare v_plane_num varchar(50) default null;
                
	-- Ensure that the flight exists
		if (select count(*) from flight f where f.flightID = ip_flightID) < 1 then 
			leave sp_main; 
		end if;
    
    set v_current_leg = 
	    (select progress from flight f where f.flightID = ip_flightID);
		set v_curr_next_time = 
			(select next_time from flight f where f.flightID = ip_flightID);
    set v_current_status = 
	    (select airplane_status from flight f where f.flightID = ip_flightID);

	-- Make sure that the flight has made any amount of progress
    if (v_current_leg is null or v_current_leg < 1) then 
	    leave sp_main; 
	   end if;
    
     -- Ensure that the flight is in the air
    if (v_current_status is null or v_current_status = 'on_ground') then 
	    leave sp_main; 
	   end if;
    
    -- Update the status of the flight and increment the next time to 1 hour later
		-- Hint: use addtime()
    set v_new_airplane_status = 'on_ground';
    set v_new_next_time = ADDTIME(v_curr_next_time, MAKETIME(1, 0, 0));
    
    update flight f 
    set f.airplane_status = v_new_airplane_status, 
    f.next_time = v_new_next_time
		where f.flightID = ip_flightID;
            
		set v_supp_airline = (select support_airline from flight f where f.flightID = ip_flightID);
    set v+supp_tail = (select support_tail from flight f where f.flightID = ip_flightID);
    -- set supp_flight = (select personID from pilot p where p.commanding_flight = ip_flightID);
	
      -- Increment the pilot's experience by 1
    update pilot p set p.experience = p.experience + 1
    where p.commanding_flight = ip_flightID;
            
		set v_num_miles = (select l.distance from (leg l join route_path rp on l.legID = rp.legID) 
                         join flight f on rp.routeID = f.routeID and rp.sequence = f.progress where f.flightID = ip_flightID);
		set v_plane_num = (select locationID from airplane a where a.airlineID = v_supp_airline and a.tail_num = v_supp_tail);
    
    -- Increment the frequent flyer miles of all passengers on the plane
		update passenger p set p.miles = p.miles + v_num_miles where p.personID in 
		(select pe.personID from person pe where pe.locationID = v_plane_num);

end //
delimiter ;
```

# 7.  flight_takeoff()

```sql
drop procedure if exists flight_takeoff;
delimiter //
create procedure flight_takeoff (in ip_flightID varchar(50))
sp_main: begin
    declare v_current_status varchar(20);
    declare v_progress int;
    declare v_routeID varchar(50);
    declare v_support_airline varchar(50);
    declare v_support_tail varchar(50);
    declare v_leg_count int;
    declare v_plane_type varchar(100);
    declare v_speed int;
    declare v_pilot_count int;
    declare v_next_legID varchar(50);
    declare v_next_leg_distance int;
    declare v_flight_time int;

    -- Get flight details
    select airplane_status, progress, routeID, support_airline, support_tail 
    into v_current_status, v_progress, v_routeID, v_support_airline, v_support_tail
    from flight 
    where flightID = ip_flightID;

    -- If flight does not exist or not on ground, exit
    IF v_current_status IS NULL OR v_current_status != 'on_ground' THEN
        LEAVE sp_main;
    END IF;

    -- Get total number of legs in the route
    select MAX(sequence) into v_leg_count 
    from route_path 
    WHERE routeID = v_routeID;

    -- Check if there is another leg to fly
    IF v_progress >= v_leg_count THEN
        LEAVE sp_main;
    END IF;

    -- Get airplane type and speed
    select plane_type, speed into v_plane_type, v_speed
    from airplane 
    where airlineID = v_support_airline AND tail_num = v_support_tail;

    -- Count assigned pilots
    select COUNT(*) INTO v_pilot_count 
    from pilot 
    where commanding_flight = ip_flightID;

    -- Check pilot requirements
    IF (v_plane_type = 'Boeing' AND v_pilot_count < 2) OR 
       ((v_plane_type != 'Boeing' OR v_plane_type IS NULL) AND v_pilot_count < 1) THEN
        UPDATE flight 
        SET next_time = ADDTIME(next_time, '00:30:00')
        where flightID = ip_flightID;
        LEAVE sp_main;
    END IF;

    -- Get next leg ID
    select legID into v_next_legID 
    from route_path 
    where routeID = v_routeID AND sequence = v_progress + 1;

    -- Get next leg distance
    select distance into v_next_leg_distance 
    from leg 
    where legID = v_next_legID;

    -- Calculate flight time in seconds
    set v_flight_time = (v_next_leg_distance / v_speed) * 3600;

    -- Update flight status, progress, and next_time
    update flight 
    set 
        airplane_status = 'in_flight',
        progress = progress + 1,
        next_time = ADDTIME(next_time, SEC_TO_TIME(v_flight_time))
    where flightID = ip_flightID;

end //
delimiter ;
```

# 8. passengers_board()

```sql
drop procedure if exists passengers_board;
delimiter //

create procedure passengers_board (in ip_flightID varchar(50))
sp_main: begin

    declare v_current_leg int default 0;
    declare v_total_legs int default 0;
    declare v_airplane_status varchar(100);
    declare v_route_id varchar(50);
    declare v_supp_airline varchar(50);
    declare v_supp_tail varchar(50);
    declare v_departing_airport char(3);
    declare v_arriving_airport char(3);
    declare v_airport_location varchar(50);
    declare v_airplane_location varchar(50);
    declare v_seat_cap int;
    declare v_flight_cost int;
    declare v_board_count int;

    -- Check if flight exists
    if not exists (select 1 from flight where flightID = ip_flightID) then
        leave sp_main;
    end if;

    -- Get flight info
    select progress, routeID, airplane_status, support_airline, support_tail, cost
    into v_current_leg, route_id, airplane_status, supp_airline, supp_tail, flight_cost
    from flight
    where flightID = ip_flightID;

    -- Flight must be on ground
    if airplane_status = 'in_flight' then
        leave sp_main;
    end if;

    -- Count total legs
    select count(*) into total_legs
    from route_path
    where routeID = route_id;

    -- Flight must have more legs
    if v_current_leg >= total_legs then
        leave sp_main;
    end if;

    -- Get next leg's departure and arrival airport
    select l.departure, l.arrival
    into departing_airport, arriving_airport
    from route_path rp
    join leg l on rp.legID = l.legID
    where rp.routeID = route_id and rp.sequence = v_current_leg + 1;

    -- Get location ID for departing airport
    select locationID into airport_location
    from airport
    where airportID = departing_airport;

    -- Get airplane's location and seat capacity
    select locationID, seat_capacity
    into airplane_location, seat_cap
    from airplane
    where airlineID = supp_airline and tail_num = supp_tail;

    -- Count eligible passengers
    select count(*)
    into passenger_boarded_ct
    from person
    join passenger on person.personID = passenger.personID
    join passenger_vacations pv on person.personID = pv.personID
    where person.locationID = airport_location
      and pv.sequence = 1
      and pv.airportID = arriving_airport
      and passenger.funds >= flight_cost;

    -- Not enough seats 
    if passenger_boarded_ct > seat_cap then
        leave sp_main;
    end if;

    -- Update boarding passengers: move location and deduct funds
    update passenger
    join person on passenger.personID = person.personID
    join passenger_vacations pv on passenger.personID = pv.personID
    set passenger.funds = passenger.funds - v_flight_cost,
        person.locationID = v_airplane_location
    where person.locationID = v_airport_location
      and pv.sequence = 1
      and pv.airportID = arriving_airport
      and passenger.funds >= flight_cost;

end //
delimiter ;
```

# 9. passengers_disembark()

```sql
DROP PROCEDURE IF EXISTS passengers_disembark;
DELIMITER //

CREATE PROCEDURE passengers_disembark (IN ip_flightID VARCHAR(50))
sp_main: BEGIN
    DECLARE v_route_id VARCHAR(50);
    DECLARE v_current_leg_id VARCHAR(50);
    DECLARE v_flight_progress INT;
    DECLARE v_arrival_airport_code CHAR(3);
    DECLARE v_arrival_location_id VARCHAR(50);
    DECLARE v_support_airline_id VARCHAR(50);
    DECLARE v_support_tail_number VARCHAR(50);
    DECLARE v_plane_location_id VARCHAR(50);

    -- Ensure the flight exists and is on the ground
    IF NOT EXISTS (SELECT 1 FROM flight WHERE flightID = ip_flightID) THEN
        LEAVE sp_main;
    END IF;

    IF (SELECT airplane_status FROM flight WHERE flightID = ip_flightID) = 'in_flight' THEN
        LEAVE sp_main;
    END IF;

    -- Retrieve flight information
    SELECT routeID, progress, support_airline, support_tail
    INTO v_route_id, v_flight_progress, v_support_airline_id, v_support_tail_number
    FROM flight
    WHERE flightID = ip_flightID;

    -- Get the current leg and arrival airport information
    SELECT leg.legID, leg.arrival
    INTO v_current_leg_id, v_arrival_airport_code
    FROM route_path
    JOIN leg ON route_path.legID = leg.legID
    WHERE routeID = v_route_id AND sequence = v_flight_progress;

    -- Fetch the arrival location corresponding to the arrival airport
    SELECT locationID
    INTO v_arrival_location_id
    FROM airport
    WHERE airportID = v_arrival_airport_code;

    -- Determine the airplane's current location
    SELECT locationID
    INTO v_plane_location_id
    FROM airplane
    WHERE airlineID = v_support_airline_id AND tail_num = v_support_tail_number;

    -- Update the location of each person who is on the plane and whose next vacation stop is this airport
    UPDATE person
    JOIN passenger_vacations pv ON person.personID = pv.personID
    SET person.locationID = v_arrival_location_id
    WHERE person.locationID = v_plane_location_id
      AND pv.sequence = 1
      AND pv.airportID = v_arrival_airport_code;

    -- Remove completed vacation steps for passengers who have disembarked
    DELETE FROM passenger_vacations
    WHERE sequence = 1
      AND airportID = v_arrival_airport_code
      AND personID IN (
          SELECT personID
          FROM person
          WHERE locationID = v_arrival_location_id
      );

END //
DELIMITER ;

```

# 10. assign_pilot()

```sql
DROP PROCEDURE IF EXISTS assign_pilot;
DELIMITER //

CREATE PROCEDURE assign_pilot (
    IN in_flight_id VARCHAR(50),
    IN in_person_id VARCHAR(50)
)
main_block: BEGIN

    DECLARE v_plane_loc VARCHAR(50);
    DECLARE v_pilot_loc VARCHAR(50);
    DECLARE v_plane_type VARCHAR(100);
    DECLARE v_airline_id VARCHAR(50);
    DECLARE v_tail_num VARCHAR(50);
    DECLARE v_route_id VARCHAR(50);
    DECLARE v_progress INT DEFAULT 0;
    DECLARE v_leg_id VARCHAR(50);
    DECLARE v_total_legs INT;
    DECLARE v_airport_id CHAR(3);
    DECLARE v_flight_status VARCHAR(100);
    DECLARE v_plane_id VARCHAR(50);

    -- Check flight exists
    IF (SELECT COUNT(*) FROM flight WHERE flightID = in_flight_id) = 0 THEN 
        LEAVE main_block;
    END IF;

    -- Check pilot exists
    IF (SELECT COUNT(*) FROM person WHERE personID = in_person_id) = 0 THEN 
        LEAVE main_block;
    END IF;

    -- Retrieve flight and airplane info
    SELECT 
        f.support_airline, f.support_tail, f.routeID, f.progress, f.airplane_status
    INTO 
        v_airline_id, v_tail_num, v_route_id, v_progress, v_flight_status
    FROM flight f
    WHERE f.flightID = in_flight_id;

    -- Ensure flight is on the ground
    IF v_flight_status = 'in_flight' THEN 
        LEAVE main_block;
    END IF;

    -- Get airplane type and location
    SELECT a.plane_type, a.locationID
    INTO v_plane_type, v_plane_id
    FROM airplane a
    WHERE a.airlineID = v_airline_id AND a.tail_num = v_tail_num;

    -- Check pilot has the license
    IF (SELECT COUNT(*) FROM pilot_licenses WHERE personID = in_person_id AND license = v_plane_type) = 0 THEN 
        LEAVE main_block;
    END IF;

    -- Get total legs in route
    SELECT COUNT(*) INTO v_total_legs
    FROM route_path
    WHERE routeID = v_route_id;

    -- Ensure flight has legs left
    IF v_progress = v_total_legs THEN 
        LEAVE main_block;
    END IF;

    -- Determine current leg and airport
    IF v_progress = 0 THEN
        SELECT rp.legID INTO v_leg_id
        FROM route_path rp
        WHERE rp.routeID = v_route_id AND rp.sequence = 1;
        
        SELECT l.departure INTO v_airport_id
        FROM leg l
        WHERE l.legID = v_leg_id;
    ELSE
        SELECT rp.legID INTO v_leg_id
        FROM route_path rp
        WHERE rp.routeID = v_route_id AND rp.sequence = v_progress;

        SELECT l.arrival INTO v_airport_id
        FROM leg l
        WHERE l.legID = v_leg_id;
    END IF;

    -- Get airport location and pilot location
    SELECT a.locationID INTO v_plane_loc
    FROM airport a
    WHERE a.airportID = v_airport_id;

    SELECT p.locationID INTO v_pilot_loc
    FROM person p
    WHERE p.personID = in_person_id;

    -- Ensure pilot is at plane's location
    IF v_plane_loc != v_pilot_loc THEN 
        LEAVE main_block;
    END IF;

    -- Ensure pilot is available
    IF (SELECT COUNT(*) FROM pilot p WHERE p.personID = in_person_id AND p.commanding_flight IS NULL) = 0 THEN 
        LEAVE main_block;
    END IF;

    -- Assign pilot and update location
    UPDATE pilot 
    SET commanding_flight = in_flight_id 
    WHERE personID = in_person_id;

    UPDATE person 
    SET locationID = v_plane_id 
    WHERE personID = in_person_id;

END //
DELIMITER ;

```

# 11. recycle_crew()

```sql
drop procedure if exists recycle_crew;
delimiter //
create procedure recycle_crew (in ip_flightid varchar(50))
sp_main: begin

		declare v_current_leg_num integer default 0;
    declare v_total_legs integer default 0;
    declare v_route_id varchar(50) default null;
    declare v_current_leg_id varchar(50) default null;
    declare v_arrival_airport_id char(3) default null;
    
    declare v_support_airline varchar(50) default null;
    declare v_support_tail varchar(50) default null;
    declare v_plane_location varchar(50) default null;
    declare v_port_location_id varchar(50) default null;
    declare v_num_passengers integer default 0;
    
    declare v_current_status varchar(100) default null;
    
    -- first check if flight exists
    if not exists (select 1 from flight where flightid = ip_flightid) then
        leave sp_main;
    end if;
    
    -- get flight details and total legs
    select 
        f.progress, f.airplane_status, f.support_airline, f.support_tail, f.routeid,
        (select count(*) from route_path where routeid = f.routeid)
    into 
        v_current_leg_num, v_current_status, v_support_airline, v_support_tail, v_route_id, v_total_legs
    from 
        flight f
    where 
        f.flightid = ip_flightid;
    
    -- make sure flight is on ground and completed
    if v_current_status = 'in_flight' or v_current_leg_num != v_total_legs then
        leave sp_main;
    end if;
    
    -- get plane location
    select locationid 
    into v_plane_location 
    from airplane 
    where airlineid = v_support_airline and tail_num = v_support_tail;
    
    -- count passengers on plane
    select count(*) 
    into v_num_passengers 
    from person 
    where locationid = v_plane_location 
      and personid in (select personid from passenger);
    
    -- ensure no passengers remain
    if v_num_passengers > 0 then
        leave sp_main;
    end if;
    
    -- get current leg, arrival airport, and port location
    select legid 
    into v_current_leg_id 
    from route_path 
    where routeid = v_route_id and sequence = v_current_leg_num;
    
    select arrival 
    into v_arrival_airport_id 
    from leg 
    where legid = v_current_leg_id;
    
    select locationid 
    into v_port_location_id 
    from airport 
    where airportid = v_arrival_airport_id;
    
    -- update pilots' location and clear assignment
    update person 
    set locationid = v_port_location_id 
    where personid in (select personid from pilot where commanding_flight = ip_flightid);
    
    update pilot 
    set commanding_flight = null 
    where commanding_flight = ip_flightid;

end //
delimiter ;
```

# 12. retire_flight()

```sql
drop procedure if exists retire_flight;
delimiter //

create procedure retire_flight(in ip_flightID varchar(50))
sp_main: begin

    declare v_flight_exists bool default false;
    declare v_current_status varchar(100);
    declare v_current_progress int default 0;
    declare v_total_legs int default 0;
    declare v_airplane_loc varchar(50);
    declare v_people_on_board int default 0;
    declare v_route_id varchar(50);
    declare v_supp_airline varchar(50);
    declare v_supp_tail varchar(50);
  
  select airplane_status, progress, routeID, support_airline, support_tail
    into v_current_status, v_current_progress, v_route_id, v_supp_airline, v_supp_tail
    from flight
    where flightID = ip_flightID;
  
-- Ensure the flight exists
    select exists(
        select 1 from flight where flightID = ip_flightID
    ) into v_flight_exists;
    if v_flight_exists = false then
        leave sp_main;
    end if;

-- Ensure that the flight is on the ground
    if v_current_status = 'in_flight' then
        leave sp_main;
    end if;

 -- Ensure that the flight does not have any more legs
    select count(*) into v_total_legs
    from route_path
    where routeID = route_id;
    if v_current_progress < v_total_legs then
        leave sp_main;
    end if;

-- Ensure that there are no more people on the plane supporting the flight
    select locationID into v_airplane_loc
    from airplane
    where airlineID = v_supp_airline and tail_num = v_supp_tail;
    select count(*) into v_people_on_board
    from person
    where locationID = v_airplane_loc;
    if v_people_on_board > 0 then
        leave sp_main;
    end if;

-- Remove the flight from the system
    delete from flight where flightID = ip_flightID;

end //
delimiter ;

```

# 13. simulation_cycle()

```sql
DROP PROCEDURE IF EXISTS simulation_cycle;
DELIMITER //

CREATE PROCEDURE simulation_cycle()
sp_main: BEGIN

    DECLARE v_flightID VARCHAR(50);
    DECLARE v_airplane_status VARCHAR(100);
    DECLARE v_routeID VARCHAR(50);
    DECLARE v_progress INT;
    DECLARE v_max_leg_seq INT;

    SELECT flightID
    INTO v_flightID
    FROM flight
    ORDER BY
        next_time ASC,
        CASE airplane_status
            WHEN 'in_flight' THEN 0
            WHEN 'on_ground' THEN 1
            ELSE 2
        END,
        flightID ASC
    LIMIT 1;

    -- Load flight details
    SELECT airplane_status, routeID, progress
    INTO v_airplane_status, v_routeID, v_progress
    FROM flight
    WHERE flightID = v_flightID;

    -- Get the total number of legs in the route
    SELECT MAX(sequence)
    INTO v_max_leg_seq
    FROM route_path
    WHERE routeID = v_routeID;

-- If the flight is in the air:
		-- Land the flight and disembark passengers
        -- If it has reached the end:
			-- Recycle crew and retire flight
            
    -- If flight is in the air ‚Üí LAND + DISEMBARK
    -- If the plane is currently flying ‚Üí LAND and DISEMBARK
    IF v_airplane_status = 'in_flight' THEN
        CALL flight_landing(v_flightID);
        CALL passengers_disembark(v_flightID);

        -- If flight has completed its last leg, recycle and retire
        IF v_progress = v_max_leg_seq THEN
            CALL recycle_crew(v_flightID);
            CALL retire_flight(v_flightID);
        END IF;

    -- If the plane is on the ground ‚Üí Either board/takeoff or retire
    ELSEIF v_airplane_status = 'on_ground' THEN

        IF v_progress = v_max_leg_seq THEN
            -- Already at final destination, retire
            CALL recycle_crew(v_flightID);
            CALL retire_flight(v_flightID);
        ELSE
            -- Not yet finished, continue journey
            CALL passengers_board(v_flightID);
            CALL flight_takeoff(v_flightID);  -- Automatically updates time
        END IF;

    END IF;

END //
DELIMITER ;

```

# 14. flights_in_the_air()

```sql
create or replace view flights_in_the_air (
    departing_from,
    arriving_at,
    num_flights,
    flight_list,
    earliest_arrival,
    latest_arrival,
    airplane_list
) as
select
    l.departure as departing_from,
    l.arrival as arriving_at,
    count(*) as num_flights,
    group_concat(f.flightID order by f.flightID separator ',') as flight_list,
    min(f.next_time) as earliest_arrival,
    max(f.next_time) as latest_arrival,
    group_concat(ap.locationID order by f.flightID separator ',') as airplane_list
from flight f
join route_path rp on f.routeID = rp.routeID and f.progress = rp.sequence
join leg l on rp.legID = l.legID
join airplane ap on f.support_airline = ap.airlineID and f.support_tail = ap.tail_num
where f.airplane_status = 'in_flight'
group by l.departure, l.arrival;
```

# 15. flights_on_the_ground()

```sql
CREATE OR REPLACE VIEW flights_on_the_ground AS
WITH on_ground_flights AS (
    SELECT f.*, a.locationID AS locID
    FROM flight_tracking.flight f
    JOIN flight_tracking.airplane a
      ON (f.support_airline, f.support_tail) = (a.airlineID, a.tail_num)
    WHERE f.airplane_status = 'on_ground'
),
flight_departures AS (
    SELECT 
        f.flightID,
        f.routeID,
        f.progress,
        CASE 
            WHEN f.progress = 0 THEN (
                SELECT l.departure
                FROM route_path rp
                JOIN leg l ON rp.legID = l.legID
                WHERE rp.routeID = f.routeID AND rp.sequence = 1
                LIMIT 1
            )
            ELSE (
                SELECT l.arrival
                FROM route_path rp
                JOIN leg l ON rp.legID = l.legID
                WHERE rp.routeID = f.routeID AND rp.sequence = f.progress
                LIMIT 1
            )
        END AS departing_from
    FROM on_ground_flights f
),
flight_grouping AS (
    SELECT 
        f.flightID,
        f.locID,
        d.departing_from
    FROM on_ground_flights f
    JOIN flight_departures d ON f.flightID = d.flightID
),
num_flights_grouping AS (
    SELECT 
        d.departing_from,
        COUNT(*) AS num_flights
    FROM flight_grouping d
    GROUP BY d.departing_from
),
arrival_grouping AS (
    SELECT 
        d.departing_from,
        MIN(f.next_time) AS earliest_arrival,
        MAX(f.next_time) AS latest_arrival
    FROM flight_grouping d
    JOIN on_ground_flights f ON d.flightID = f.flightID
    GROUP BY d.departing_from
)
SELECT 
    fg.departing_from,
    nfg.num_flights,
    GROUP_CONCAT(fg.flightID) AS flight_list,
    ag.earliest_arrival,
    ag.latest_arrival,
    GROUP_CONCAT(fg.locID) AS airplane_list
FROM flight_grouping fg
JOIN num_flights_grouping nfg ON fg.departing_from = nfg.departing_from
JOIN arrival_grouping ag ON fg.departing_from = ag.departing_from
GROUP BY 
    fg.departing_from,
    nfg.num_flights,
    ag.earliest_arrival,
    ag.latest_arrival;

```

# 16. people_in_the_air()

```sql
create or replace view people_in_the_air (
    departing_from,
    arriving_at,
    num_airplanes,
    airplane_list,
    flight_list,
    earliest_arrival,
    latest_arrival,
    num_pilots,
    num_passengers,
    joint_pilots_passengers,
    person_list
) as
select
    l.departure as departing_from,
    l.arrival as arriving_at,
    count(distinct f.flightID) as num_airplanes,
    group_concat(distinct ap.locationID order by ap.locationID separator ',') as airplane_list,
    group_concat(distinct f.flightID order by f.flightID separator ',') as flight_list,
    min(f.next_time) as earliest_arrival,
    max(f.next_time) as latest_arrival,
    count(distinct pl.personID) as num_pilots,
    count(distinct ps.personID) as num_passengers,
    count(distinct coalesce(pl.personID, ps.personID)) as joint_pilots_passengers,
    group_concat(distinct p.personID order by p.personID separator ',') as person_list
from flight f
join route_path rp on f.routeID = rp.routeID and f.progress = rp.sequence
join leg l on rp.legID = l.legID
join airplane ap on ap.airlineID = f.support_airline and ap.tail_num = f.support_tail
join person p on p.locationID = ap.locationID
left join pilot pl on p.personID = pl.personID
left join passenger ps on p.personID = ps.personID
where f.airplane_status = 'in_flight'
group by l.departure, l.arrival;

```

# 17. people_on_the_ground()

```sql
create or replace view people_on_the_ground (
    departing_from,
    airport,
    airport_name,
    city,
    state,
    country,
    num_pilots,
    num_passengers,
    joint_pilots_passengers,
    person_list
) as
select
    a.airportID as departing_from,
    a.locationID as airport,
    a.airport_name,
    a.city,
    a.state,
    a.country,
    count(distinct pl.personID) as num_pilots,
    count(distinct ps.personID) as num_passengers,
    count(distinct coalesce(pl.personID, ps.personID)) as joint_pilots_passengers,
    group_concat(distinct p.personID order by p.personID separator ',') as person_list
from airport a
join person p on p.locationID = a.locationID
left join pilot pl on pl.personID = p.personID
left join passenger ps on ps.personID = p.personID
group by
    a.airportID, a.locationID, a.airport_name, a.city, a.state, a.country;
```

# 18. route_summary()

```sql
create or replace view route_summary (
    route,
    num_legs,
    leg_sequence,
    route_length,
    num_flights,
    flight_list,
    airport_sequence
) as
select
    r.routeID as route,
    count(rp.legID) as num_legs,
    group_concat(rp.legID order by rp.sequence separator ', ') as leg_sequence,
    sum(l.distance) as route_length,
    (select count(*) from flight f where f.routeID = r.routeID) as num_flights,
    (select group_concat(f.flightID order by f.flightID separator ', ')
     from flight f where f.routeID = r.routeID) as flight_list,
    group_concat(concat(l.departure, '->', l.arrival) order by rp.sequence separator ', ') as airport_sequence
from route r
join route_path rp on r.routeID = rp.routeID
join leg l on rp.legID = l.legID
group by r.routeID;
```

# 19. alternative_airports()

```sql
create or replace view alternative_airports (
    city, state, country, num_airports,
    airport_code_list, airport_name_list
) as
select
    city,
    state,
    country,
    count(*) as num_airports,
    group_concat(airportID order by airportID separator ',') as airport_code_list,
    group_concat(airport_name order by airportID separator ',') as airport_name_list
from airport
group by city, state, country
having count(*) > 1;
```
